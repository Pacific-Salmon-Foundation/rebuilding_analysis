---
title: "Appendix X: Chinook Rebuilding System Dashboards"
output: html_notebook
editor_options: 
  chunk_output_type: console
---


```{r startup}
setwd("C:/Users/andy1/Documents/R/rebuilding_analysis")

library(data.table)
library(tidyverse)
library(RColorBrewer)
library(ggpubr)
library(dplyr)
library(tidyr)
library(readxl)
library(patchwork)
```


```{r clean data load}
esc.data<-readRDS("data clean/Chinook rebuilding systems spawner data from nuseds.RDS")

rel.data<-readRDS("data clean/chinook rebuilding systems releases.RDS")



```

```{r dashboards}

#### escapement figure ####
sys.name<-"Ashlu Creek"
esc.sp<-"CN"
rel.sp<-"Chinook"
esc.sys<-"ASHLU CREEK"
rel.sys<-"Ashlu Cr"
enh.sys<-"Ashlu Cr"  
pni.sys<-"Ashlu Creek"

wcvicn<-cn.control%>%filter(Region=="WCVI")
j=1

sys.name<-wcvicn$nuseds.link[j]
esc.sp<-"CN"
rel.sp<-"Chinook"
esc.sys<-wcvicn$nuseds.link[j]
rel.sys<-"Ashlu Cr"
enh.sys<-"Ashlu Cr"  
pni.sys<-"Ashlu Creek"

names(esc.data)

esc<-esc.data%>%filter(SYS_NM==esc.sys)

plot.esc<-ggplot(esc,aes(x=year,y=escapement,color=SYS_NM))+
  geom_point()+geom_line()+theme_bw()+
  xlim(1950,2020)+
  labs(y="Escapement",x="Return Year",color="System Name")+
  scale_colour_brewer(palette="Set1")
  
plot.esc

rel<-rel2%>%filter(RELEASE_SITE_NAME==rel.sys&SPECIES_NAME==rel.sp)%>%
  group_by(RELEASE_YEAR,RELEASE_SITE_NAME,RELEASE_STAGE_NAME)%>%
  summarise(releases=sum(TotalRelease))%>%
  arrange(RELEASE_SITE_NAME,RELEASE_STAGE_NAME,RELEASE_YEAR)

idx <- c(1, diff(rel$RELEASE_YEAR))
i2 <- c(1,which(idx != 1), nrow(rel)+1)
rel$grp <- rep(1:length(diff(i2)), diff(i2))

plot.releases<-ggplot(rel,aes(x=RELEASE_YEAR,y=releases,color=RELEASE_STAGE_NAME,shape=RELEASE_SITE_NAME,group=grp))+
  geom_point()+geom_line()+
  scale_color_brewer(palette="Set1")+
  theme_bw()+
  xlim(1950,2020)+
  labs(x="Release Year",y="Total Releases by Site/Stage",color="Stage",shape="Site")

plot.releases

enh.cont<-enh.data%>%filter(`Return Site`==enh.sys&`Sex/Maturity`=="Total Adults")%>%
  arrange(`Composite Type`,`Recovery Year`)

idx <- c(1, diff(enh.cont$`Recovery Year`))
i2 <- c(1,which(idx != 1), nrow(enh.cont)+1)
enh.cont$grp <- rep(1:length(diff(i2)), diff(i2))

plot.enh<-ggplot(enh.cont,aes(x=`Recovery Year`,y=`Enh Contr %`,color=`Composite Type`))+
  geom_point(alpha=.7)+geom_line(alpha=.7)+
  scale_color_brewer(palette="Set1")+
  theme_bw()+
  xlim(1950,2020)+
  ylim(0,100)+
  labs(y="Enhanced Contribution %")

plot.enh

yrs<-seq(1960,2020,1)

phos.plot.data<-pni.data.clean%>%filter(Population==pni.sys)%>%
  select(Year,CWT=phos.cwt,Thermal=phos.thermal)%>%
  pivot_longer(2:3,names_to="Mark Type",values_to="value")
  
plot.phos<-ggplot(phos.plot.data,aes(x=Year,y=value,color=`Mark Type`))+
  geom_point()+geom_line()+
  theme_bw()+
  labs(y="pHOS")+
  scale_color_brewer(palette="Set1")+
  ylim(0,1)

plot.phos
names(pni.data.clean)

pni.plot.data<-pni.data.clean%>%filter(Population==pni.sys)%>%
  select(Year,CWT=pni.cwt,Thermal=pni.thermal)%>%
  pivot_longer(2:3,names_to="Mark Type",values_to="value")
  
plot.pni<-ggplot(pni.plot.data,aes(x=Year,y=value,color=`Mark Type`))+
  geom_point()+geom_line()+
  scale_color_brewer(palette="Set1")+
  theme_bw()+
  labs(y="PNI")+
  ylim(0,1)

plot.pni


pnis<-(plot.phos|plot.pni)+plot_layout(guides='collect')
pnis

(plot.esc/plot.releases/plot.enh)/pnis 

ggsave("figures/test.png",dpi=600,height=9,width=7)
#ggsave("junk.png",dpi=600,height=8,width=7)

```

